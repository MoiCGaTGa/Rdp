name: Rdp-Tailscaleü§£

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-2022
    timeout-minutes: 340
    
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by Coder" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta

      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389

      # ===== T·∫†O USER PREMIUM (FIX PASSWORD) =====
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N
        env:
          CUSTOM_RDP_PASS: ${{ secrets.CUSTOM_RDP_PASS }}
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N" -ForegroundColor Yellow

          # X·ª¨ L√ù M·∫¨T KH·∫®U ‚Äì B·∫ÆT BU·ªòC C√ì SECRET
          if ($env:CUSTOM_RDP_PASS -and $env:CUSTOM_RDP_PASS.Length -ge 6) {
              $matKhau = $env:CUSTOM_RDP_PASS
              Write-Host "‚îÇ üîê D√πng m·∫≠t kh·∫©u t·ª´ CUSTOM_RDP_PASS" -ForegroundColor Blue
          } else {
              Write-Host "‚îÇ ‚ùå CUSTOM_RDP_PASS kh√¥ng t·ªìn t·∫°i ho·∫∑c qu√° ng·∫Øn" -ForegroundColor Red
              exit 1
          }

          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force

          Remove-LocalUser -Name "Dev" -ErrorAction SilentlyContinue

          New-LocalUser -Name "Dev" -Password $securePass -AccountNeverExpires -Description "Rdp TailScale"
          Set-LocalUser -Name "Dev" -PasswordNeverExpires $true
          Add-LocalGroupMember -Group "Administrators" -Member "Dev"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Dev"
          Enable-LocalUser -Name "Dev"

          echo "RDP_USER=Dev" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt

          Write-Host "‚úÖ User Dev ƒë√£ s·∫µn s√†ng" -ForegroundColor Green
      # ===== H·∫æT PH·∫¶N FIX =====

      - name: üåê THI·∫æT L·∫¨P TAILSCALE
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          $msi="$env:TEMP\tailscale.msi"
          Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --reset

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $pass = Get-Content $env:TEMP\rdp_password.txt
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          Write-Host "=============================="
          Write-Host "IP: $ip"
          Write-Host "User: Dev"
          Write-Host "Pass: $pass"
          Write-Host "Port: 3389"
          Write-Host "=============================="

      - name: ‚è≥ GI·ªÆ PHI√äN
        run: |
          Start-Sleep -Seconds 20400
